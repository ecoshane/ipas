<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>iPASæ·¨é›¶ä¸­ç´šè€ƒè©¦ç·´ç¿’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f1f5f9; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const AppTitle = "iPASæ·¨é›¶ä¸­ç´šè€ƒè©¦ç·´ç¿’ç³»çµ±";
        const ThemeColor = "blue"; 

        const IconBase = ({ children, size=24, className="" }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const FileJson = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M10 13a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2"/><path d="M14 13a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2"/></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const FolderOpen = (p) => <IconBase {...p}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const FileSpreadsheet = (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h8"/><path d="M8 17h8"/><path d="M14 13v4"/></IconBase>;
        const MessageCircleQuestion = (p) => <IconBase {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="M6 6 18 18"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const ChevronUp = (p) => <IconBase {...p}><polyline points="18 15 12 9 6 15"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><polyline points="6 9 12 15 18 9"/></IconBase>;

        const EXAM_STRUCTURE = {
          "è€ƒç§‘ä¸€ï¼šç¯€èƒ½æ¸›ç¢³æŠ€è¡“å¯¦å‹™": {
            "çµ„ç¹”ç¯€èƒ½æ¸›ç¢³ç­–ç•¥": ["æ¸›ç¢³/ç¯€èƒ½ç›®æ¨™è¨­å®šèˆ‡è·¯å¾‘è¦åŠƒ", "ç¢³æ’ç†±å€è¾¨è­˜èˆ‡èƒ½æºç›¤æŸ¥è³‡æ–™è§£æ", "è²¡å‹™æ±ºç­–æ¨¡å‹èˆ‡é¢¨éšªè©•ä¼°"],
            "ç¯€èƒ½æŠ€è¡“æ‡‰ç”¨èˆ‡èƒ½æºç®¡ç†": ["å…¬ç”¨è¨­æ–½ç¯€èƒ½æŠ€è¡“é¸ç”¨åˆ†æ", "ç¯€èƒ½æŠ€è¡“æŠ•è³‡æ•ˆç›Šèˆ‡å›æ”¶æœŸè©•ä¼°", "ESCOæ‡‰ç”¨å¯¦å‹™", "ISO 50001èƒ½æºç®¡ç†ç³»çµ±å°å…¥èˆ‡é‹ç”¨", "ç¯€èƒ½ç›¸é—œå‰ç»æŠ€è¡“"],
            "å†ç”Ÿèƒ½æºèˆ‡ç¶ é›»å°å…¥": ["å†ç”Ÿèƒ½æºç¨®é¡åŠå„ªç¼ºé»æ¯”è¼ƒ", "åœ‹å…§å†ç”Ÿèƒ½æºå°å…¥åŠæ•ˆç›Šè©•ä¼°", "ç¶ é›»æ¡è³¼æ¨¡å¼èˆ‡åˆ¶åº¦"]
          },
          "è€ƒç§‘äºŒï¼šç¢³ç®¡ç†åˆ¶åº¦å¯¦å‹™": {
            "ç¢³è¦ç¯„å¯¦å‹™èˆ‡æ­éœ²æº–å‰‡æ‡‰ç”¨": ["åœ‹å…§æ°£å€™ç›¸é—œæ”¿ç­–èˆ‡æ¸›ç¢³æ³•è¦ä¹‹æ‡‰ç”¨", "åœ‹éš›æ­éœ²åˆ¶åº¦æ¶æ§‹ç†è§£èˆ‡å¯¦å‹™æ‡‰ç”¨", "æ¸›ç¢³ç›¸é—œå€¡è­°èˆ‡æº–å‰‡å¯¦å‹™æ¥è»Œ"],
            "çµ„ç¹”è‡ªé¡˜æ¸›é‡å¯¦å‹™": ["åœ‹å…§å¤–è‡ªé¡˜æ¸›é‡å°ˆæ¡ˆèˆ‡æŠµæ›åˆ¶åº¦", "ç¢³ç§»é™¤èˆ‡è² ç¢³æŠ€è¡“", "ç¢³æŠµæ›èˆ‡ç¢³è³‡æºäº¤æ˜“", "å…§éƒ¨ç¢³å®šåƒ¹èˆ‡ç¢³è³‡ç”¢ç®¡ç†"],
            "æ°¸çºŒä¾›æ‡‰éˆç®¡ç†": ["ç¯„ç–‡ä¸‰ç¢³æ’æ•¸æ“šç›¤æŸ¥èˆ‡ä¼°ç®—å¯¦å‹™", "ä¾›æ‡‰éˆæ¸›ç¢³é¢¨éšªè©•ä¼°èˆ‡ç®¡ç†æ©Ÿåˆ¶"]
          }
        };

        function ExamSystem() {
          const [questions, setQuestions] = useState(() => {
            try { return JSON.parse(localStorage.getItem('myExamBank_v2')) || []; } catch { return []; }
          });
          const [wrongBank, setWrongBank] = useState(() => {
             try { return JSON.parse(localStorage.getItem('myWrongBank_v2')) || []; } catch { return []; }
          });
          const [activeTab, setActiveTab] = useState('add');
          const [notification, setNotification] = useState(null);
          const [newQ, setNewQ] = useState({ subject: '', section: '', topic: '', question: '', options: ['', '', '', ''], correctAnswer: '', explanation: '' });
          const [bulkPreview, setBulkPreview] = useState([]);
          const [quizConfig, setQuizConfig] = useState({ subject: 'all', mode: 'normal' });
          const [currentQuiz, setCurrentQuiz] = useState([]);
          const [quizIndex, setQuizIndex] = useState(0);
          // quizAnswers: { [questionId]: userSelection }
          const [quizAnswers, setQuizAnswers] = useState({});
          const [isQuizActive, setIsQuizActive] = useState(false);

          useEffect(() => { localStorage.setItem('myExamBank_v2', JSON.stringify(questions)); }, [questions]);
          useEffect(() => { localStorage.setItem('myWrongBank_v2', JSON.stringify(wrongBank)); }, [wrongBank]);

          const showNotify = (msg, type = 'success') => {
            setNotification({ msg, type });
            setTimeout(() => setNotification(null), 3000);
          };

          const getSubjects = () => [...new Set([...Object.keys(EXAM_STRUCTURE), ...questions.map(q => q.subject).filter(Boolean)])];
          const getSections = (sub) => [...new Set([...(EXAM_STRUCTURE[sub] ? Object.keys(EXAM_STRUCTURE[sub]) : []), ...questions.filter(q => q.subject === sub).map(q => q.section).filter(Boolean)])];
          const getTopics = (sub, sec) => [...new Set([...((EXAM_STRUCTURE[sub] && EXAM_STRUCTURE[sub][sec]) ? EXAM_STRUCTURE[sub][sec] : []), ...questions.filter(q => q.subject === sub && q.section === sec).map(q => q.topic).filter(Boolean)])];

          const handleNavChange = (tab) => {
            if (tab === 'quiz') {
                if (isQuizActive && currentQuiz.length) activeTab === 'quiz_running' || quizIndex >= currentQuiz.length ? setActiveTab(quizIndex >= currentQuiz.length ? 'quiz_summary' : 'quiz_running') : setActiveTab('quiz');
                else setActiveTab('quiz');
            } else setActiveTab(tab);
          };

          const saveQuestion = () => {
            if (!newQ.subject || !newQ.question || !newQ.correctAnswer) return showNotify("è³‡æ–™ä¸å®Œæ•´", 'error');
            setQuestions([...questions, { ...newQ, id: Date.now() }]);
            showNotify("å·²æ–°å¢");
            setNewQ({ ...newQ, question: '', options: ['', '', '', ''], correctAnswer: '', explanation: '' });
          };
          
          const deleteQuestion = (id) => {
            if (confirm("åˆªé™¤æ­¤é¡Œï¼Ÿ")) {
              setQuestions(questions.filter(q => q.id !== id));
              setWrongBank(wrongBank.filter(qid => qid !== id));
              showNotify("å·²åˆªé™¤");
            }
          };

          const exportToExcel = () => {
             if(!questions.length) return showNotify('ç„¡è³‡æ–™å¯åŒ¯å‡º', 'error');
             const ws = XLSX.utils.json_to_sheet(questions.map(q => ({'ç§‘ç›®':q.subject,'ä¸»é¡Œ':q.section,'å…§å®¹':q.topic,'é¡Œç›®':q.question,'A':q.options[0],'B':q.options[1],'C':q.options[2],'D':q.options[3],'æ­£ç¢ºç­”æ¡ˆ':q.correctAnswer,'è§£æ':q.explanation})));
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "é¡Œåº«");
             XLSX.writeFile(wb, `iPAS_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
          };

          const handleExcelUpload = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const ws = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(evt.target.result), {type: 'array'}).SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                    const parsed = [];
                    rows.forEach((r, i) => {
                        if (r.length < 4 || String(r[0]).includes('ç§‘ç›®')) return;
                        const opts = [r[4],r[5],r[6],r[7]].filter(o=>o&&String(o).trim()).map(String);
                        let c = r[8]?String(r[8]).trim():'';
                        if(['A','B','C','D'].includes(c.toUpperCase())) c = opts[c.toUpperCase().charCodeAt(0)-65];
                        if(r[3]) parsed.push({id: Date.now()+i, subject:r[0]||'æœªåˆ†é¡', section:r[1]||'', topic:r[2]||'', question:r[3], options:opts, correctAnswer:c, explanation:r[9]||''});
                    });
                    setBulkPreview(parsed);
                    parsed.length ? showNotify(`è§£æ ${parsed.length} ç­†`) : showNotify("ç„¡è³‡æ–™", 'error');
                } catch { showNotify("è®€å–å¤±æ•—", 'error'); }
            };
            r.readAsArrayBuffer(f);
            e.target.value = '';
          };

          const startQuiz = () => {
            let qList = quizConfig.mode === 'wrong_review' ? questions.filter(q => wrongBank.includes(q.id)) : [...questions];
            if (quizConfig.subject !== 'all') qList = qList.filter(q => q.subject === quizConfig.subject);
            if (!qList.length) return showNotify("ç„¡é¡Œç›®", 'error');
            setCurrentQuiz(qList.sort(() => Math.random() - 0.5));
            setQuizIndex(0); 
            setQuizAnswers({}); // Reset answers
            setIsQuizActive(true); 
            setActiveTab('quiz_running');
          };

          const handleAnswerSubmit = (opt) => {
            const q = currentQuiz[quizIndex];
            // Prevent changing answer if already answered (optional, but requested for 'Next/Prev' stability)
            if (quizAnswers[q.id]) return;

            setQuizAnswers(prev => ({...prev, [q.id]: opt}));
            
            // Update Wrong Bank
            if (opt === q.correctAnswer) {
                if (wrongBank.includes(q.id)) setWrongBank(prev => prev.filter(id => id !== q.id));
            } else if (!wrongBank.includes(q.id)) {
                setWrongBank(prev => [...prev, q.id]);
            }
          };

          // Calculate score based on quizAnswers
          const calculateScore = () => {
              return currentQuiz.reduce((acc, q) => {
                  return (quizAnswers[q.id] === q.correctAnswer) ? acc + 1 : acc;
              }, 0);
          };

          const ProgressBar = ({ c, t }) => <div className="w-full bg-slate-200 rounded-full h-2.5 mb-6 overflow-hidden"><div className={`bg-${ThemeColor}-600 h-2.5 rounded-full transition-all duration-500`} style={{ width: `${Math.round(((c + 1) / t) * 100)}%` }}></div></div>;

          return (
            <div className={`min-h-screen pb-20 font-sans text-slate-800 selection:bg-${ThemeColor}-100 selection:text-${ThemeColor}-900`}>
              <div className="bg-white/90 backdrop-blur-md sticky top-0 z-20 border-b border-slate-200">
                <div className="max-w-5xl mx-auto">
                    <div className="px-4 py-4 flex items-center">
                        <div className={`bg-gradient-to-br from-${ThemeColor}-600 to-${ThemeColor}-700 p-2 rounded-xl mr-3 shadow-lg shadow-${ThemeColor}-200`}>
                            <FileJson className="text-white" size={24}/>
                        </div>
                        <div className="font-black text-xl tracking-tight text-slate-800">{AppTitle}</div>
                    </div>
                    <div className="flex bg-slate-800 text-white p-1 overflow-x-auto shadow-md no-scrollbar justify-center">
                      {[['add', <Plus size={18}/>, 'æ–°å¢'], ['bank', <BookOpen size={18}/>, `é¡Œåº« (${questions.length})`], ['import', <FolderOpen size={18}/>, 'ç®¡ç†']].map(([k, i, t]) => (
                          <button key={k} onClick={() => handleNavChange(k)} className={`flex items-center px-4 py-3 text-sm font-medium transition whitespace-nowrap ${activeTab === k ? `bg-${ThemeColor}-600 text-white border-b-2 border-${ThemeColor}-400` : 'hover:bg-slate-700 text-slate-300'}`}>{i} <span className="ml-2">{t}</span></button>
                      ))}
                      <button onClick={() => handleNavChange('quiz')} className={`flex items-center px-6 py-3 text-sm font-bold transition whitespace-nowrap relative ${activeTab.includes('quiz') ? `bg-${ThemeColor}-500 text-white` : 'bg-slate-700 text-white hover:bg-slate-600'}`}>
                        <Play size={18} className="mr-2" /> æ¸¬é©—
                        {isQuizActive && <span className="absolute top-2 right-2 w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>}
                      </button>
                    </div>
                </div>
                {notification && <div className={`fixed top-24 right-4 px-6 py-3 rounded-xl shadow-2xl animate-bounce z-50 font-bold flex items-center ${notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-slate-800 text-white'}`}>{notification.type === 'error' && <AlertTriangle size={18} className="mr-2"/>}{notification.msg}</div>}
              </div>

              <div className="max-w-5xl mx-auto mt-4 px-3 sm:px-4">
                {activeTab === 'add' && (
                   <div className="max-w-3xl mx-auto p-6 bg-white rounded-xl shadow-lg border border-slate-100 mt-6 animate-fade-in">
                     <h2 className={`text-xl font-bold mb-6 text-slate-800 flex items-center pb-4 border-b`}> <Plus size={24} className={`mr-2 text-${ThemeColor}-600`}/> æ–°å¢è©¦é¡Œ </h2>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                       <input list="subjects" className="w-full p-3 border border-slate-200 rounded-lg outline-none" value={newQ.subject} onChange={e=>setNewQ({...newQ, subject: e.target.value})} placeholder="ç§‘ç›®..."/>
                       <input list="sections" className="w-full p-3 border border-slate-200 rounded-lg outline-none" value={newQ.section} onChange={e=>setNewQ({...newQ, section: e.target.value})} placeholder="ä¸»é¡Œ..."/>
                       <datalist id="subjects">{getSubjects().map(s=><option key={s} value={s}/>)}</datalist><datalist id="sections">{getSections(newQ.subject).map(s=><option key={s} value={s}/>)}</datalist>
                     </div>
                     <textarea className="w-full p-3 border border-slate-200 rounded-lg h-32 outline-none mb-6" value={newQ.question} onChange={e=>setNewQ({...newQ, question: e.target.value})} placeholder="é¡Œç›®æ•˜è¿°..."/>
                     <div className="mb-6 bg-slate-50 p-4 rounded-lg">
                        {newQ.options.map((opt, i) => (
                            <div key={i} className="flex items-center mb-3 gap-3">
                                <input type="radio" checked={newQ.correctAnswer === opt && opt !== ''} onChange={()=>setNewQ({...newQ, correctAnswer: opt})} className={`w-5 h-5 accent-${ThemeColor}-600 cursor-pointer`}/>
                                <span className="text-slate-400 font-mono w-6">{String.fromCharCode(65+i)}</span>
                                <input type="text" className="flex-1 p-2 border border-slate-200 rounded outline-none" value={opt} onChange={e=>{const n=[...newQ.options];n[i]=e.target.value;setNewQ({...newQ,options:n})}} placeholder={`é¸é … ${i+1}`}/>
                                <button onClick={()=>{const n=newQ.options.filter((_,x)=>x!==i);setNewQ({...newQ,options:n})}} className="text-slate-400 hover:text-red-500"><Trash2 size={18}/></button>
                            </div>
                        ))}
                        <button onClick={()=>setNewQ({...newQ, options: [...newQ.options, '']})} className={`text-sm text-${ThemeColor}-600 font-bold flex items-center`}><Plus size={16}/> å¢åŠ é¸é …</button>
                     </div>
                     <textarea className="w-full p-3 border border-slate-200 rounded-lg h-24 outline-none mb-6" value={newQ.explanation} onChange={e=>setNewQ({...newQ, explanation: e.target.value})} placeholder="è§£æ..."/>
                     <button onClick={saveQuestion} className={`w-full bg-${ThemeColor}-600 text-white py-3 rounded-lg font-bold hover:bg-${ThemeColor}-700 shadow-lg flex justify-center items-center`}> <Save className="mr-2"/> å„²å­˜ </button>
                   </div>
                )}
                {activeTab === 'bank' && (
                   <div className="max-w-4xl mx-auto p-4 animate-fade-in">
                     <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center"> <BookOpen size={24} className={`mr-2 text-${ThemeColor}-600`}/> é¡Œåº« </h2>
                        <input type="text" placeholder="æœå°‹..." className="p-2 border border-slate-200 rounded-lg text-sm outline-none w-48" onChange={e=>{/* implement search if needed later */}}/>
                     </div>
                     <div className="space-y-4">
                        {questions.length === 0 ? <div className="text-center py-20 text-slate-400 bg-white rounded-xl border-dashed border-2">ç„¡é¡Œç›®</div> : questions.map((q) => (
                            <div key={q.id} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative group hover:shadow-md">
                                <button onClick={()=>deleteQuestion(q.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><Trash2 size={20}/></button>
                                <div className="flex gap-2 mb-3 text-xs"><span className={`bg-${ThemeColor}-100 text-${ThemeColor}-800 px-2 py-1 rounded font-bold`}>{q.subject}</span>{wrongBank.includes(q.id)&&<span className="bg-red-100 text-red-600 px-2 py-1 rounded font-bold">æ˜“éŒ¯é¡Œ</span>}</div>
                                <h3 className="font-bold text-slate-800 mb-3">{q.question}</h3>
                                <div className="grid gap-2 text-sm text-slate-600 pl-4 border-l-2 border-slate-100">
                                    {q.options.map((opt, i) => <div key={i} className={opt===q.correctAnswer?'text-green-600 font-bold':''}>{String.fromCharCode(65+i)}. {opt}</div>)}
                                </div>
                                {q.explanation && <div className="text-xs text-slate-500 bg-slate-50 p-3 rounded mt-2">è§£æï¼š{q.explanation}</div>}
                            </div>
                        ))}
                     </div>
                   </div>
                )}
                {activeTab === 'import' && (
                   <div className="max-w-4xl mx-auto p-4 space-y-6 animate-fade-in">
                      <section className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                          <h3 className="font-bold text-xl mb-4 text-slate-800 flex items-center"><FileSpreadsheet className="mr-2 text-green-600"/> åŒ¯å…¥é¡Œåº« (Excel)</h3>
                          <input type="file" accept=".xlsx,.xls" onChange={handleExcelUpload} className={`block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-${ThemeColor}-50 file:text-${ThemeColor}-700 hover:file:bg-${ThemeColor}-100`}/>
                          {bulkPreview.length > 0 && <button onClick={()=>{setQuestions([...questions,...bulkPreview]);setBulkPreview([]);showNotify(`å·²åŒ¯å…¥ ${bulkPreview.length} é¡Œ`)}} className="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center"><CheckCircle size={18} className="mr-2"/> ç¢ºèªåŒ¯å…¥</button>}
                      </section>
                      <section className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                          <h3 className={`font-bold text-xl mb-4 text-slate-800 flex items-center`}> <Save className={`mr-2 text-${ThemeColor}-600`}/> åŒ¯å‡ºé¡Œåº« </h3>
                          <button onClick={exportToExcel} className="p-4 border border-slate-200 rounded-lg hover:bg-slate-50 text-left w-full group">
                              <div className="font-bold text-slate-700 flex items-center mb-1"><Download size={20} className="mr-2"/> åŒ¯å‡º Excel</div>
                              <div className="text-xs text-slate-500">ä¸‹è¼‰ .xlsx å‚™ä»½</div>
                          </button>
                      </section>
                      <section className="bg-red-50 p-6 rounded-xl border border-red-100 flex gap-4">
                          <button onClick={()=>{if(confirm('æ¸…ç©ºéŒ¯é¡Œï¼Ÿ')){setWrongBank([]);showNotify('å·²æ¸…ç©º');}}} className="text-sm bg-white border border-red-200 text-red-600 px-4 py-2 rounded">æ¸…ç©ºéŒ¯é¡Œ</button>
                          <button onClick={()=>{if(confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰é¡Œç›®èˆ‡ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦é‡ç½®ç³»çµ±å—ï¼Ÿ')){setQuestions([]);setWrongBank([]);showNotify('å·²é‡ç½®');}}} className="text-sm bg-red-600 text-white px-4 py-2 rounded">é‡ç½®ç³»çµ±</button>
                      </section>
                   </div>
                )}
                {activeTab === 'quiz' && (
                   <div className="max-w-md mx-auto mt-10 p-8 bg-white rounded-2xl shadow-xl border border-slate-100 text-center animate-fade-in">
                      <h2 className="text-2xl font-bold mb-8 text-slate-800">æº–å‚™æ¸¬é©—</h2>
                      <select className="w-full p-3 border border-slate-200 rounded-lg mb-6 outline-none" value={quizConfig.subject} onChange={e=>setQuizConfig({...quizConfig, subject: e.target.value})}>
                          <option value="all">æ‰€æœ‰ç§‘ç›®</option>{getSubjects().map(s=><option key={s} value={s}>{s}</option>)}
                      </select>
                      <div className="grid grid-cols-2 gap-3 mb-8">
                          <button onClick={()=>setQuizConfig({...quizConfig, mode: 'normal'})} className={`p-3 rounded-lg border-2 font-bold ${quizConfig.mode==='normal'?`border-${ThemeColor}-500 bg-${ThemeColor}-50 text-${ThemeColor}-700`:'border-slate-100 text-slate-400'}`}>éš¨æ©Ÿæ¸¬é©—</button>
                          <button onClick={()=>setQuizConfig({...quizConfig, mode: 'wrong_review'})} className={`p-3 rounded-lg border-2 font-bold ${quizConfig.mode==='wrong_review'?'border-red-500 bg-red-50 text-red-700':'border-slate-100 text-slate-400'}`}>éŒ¯é¡Œè¤‡ç¿’ ({questions.filter(q=>wrongBank.includes(q.id)).length})</button>
                      </div>
                      <button onClick={startQuiz} className={`w-full bg-${ThemeColor}-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg`}>é–‹å§‹</button>
                   </div>
                )}
                {activeTab === 'quiz_running' && currentQuiz[quizIndex] && (() => {
                   const q = currentQuiz[quizIndex];
                   const userAnswer = quizAnswers[q.id]; // Get answer from state
                   const hasAnswered = !!userAnswer;
                   
                   return (
                     <div className="relative">
                       {/* Side Navigation Buttons - Fixed Position */}
                       <div className="fixed right-4 md:right-8 top-1/2 -translate-y-1/2 flex flex-col gap-4 z-50">
                          <button 
                            onClick={() => setQuizIndex(i => Math.max(0, i - 1))} 
                            disabled={quizIndex === 0}
                            className={`p-3 rounded-full shadow-lg transition-transform hover:scale-110 flex flex-col items-center justify-center gap-1 ${quizIndex === 0 ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-white text-slate-700 hover:text-blue-600 border border-slate-200'}`}
                            title="ä¸Šä¸€é¡Œ"
                          >
                            <ChevronUp size={20} />
                            <span className="text-[10px] font-bold">ä¸Šä¸€é¡Œ</span>
                          </button>
                          <button 
                            onClick={() => {
                                if (quizIndex < currentQuiz.length - 1) {
                                    setQuizIndex(i => i + 1);
                                } else if (hasAnswered) {
                                    setActiveTab('quiz_summary');
                                }
                            }} 
                            disabled={!hasAnswered && quizIndex === currentQuiz.length - 1}
                            className={`p-3 rounded-full shadow-lg transition-transform hover:scale-110 flex flex-col items-center justify-center gap-1 ${(!hasAnswered && quizIndex === currentQuiz.length - 1) ? 'bg-slate-200 text-slate-400' : `bg-${ThemeColor}-600 text-white hover:bg-${ThemeColor}-700`}`}
                            title="ä¸‹ä¸€é¡Œ"
                          >
                            <ChevronDown size={20} />
                            <span className="text-[10px] font-bold">ä¸‹ä¸€é¡Œ</span>
                          </button>
                       </div>

                       <div className="max-w-3xl mx-auto mt-4 p-6 bg-white rounded-2xl shadow-xl border border-slate-100 animate-fade-in min-h-[60vh] flex flex-col">
                          <div className="flex justify-between mb-6">
                              <span className="text-xs font-bold text-slate-400 uppercase">Q {quizIndex + 1} / {currentQuiz.length}</span>
                              <button onClick={()=>setActiveTab('quiz_summary')} className="text-slate-400 hover:text-red-500 text-sm font-bold">çµæŸ</button>
                          </div>
                          <ProgressBar c={quizIndex} t={currentQuiz.length} />
                          <h2 className="text-xl md:text-2xl font-bold text-slate-800 mb-8 flex-grow">{q.question}</h2>
                          <div className="space-y-3 mb-8">
                             {q.options.map((opt, i) => (
                                 <button key={i} onClick={() => !hasAnswered && handleAnswerSubmit(opt)} disabled={hasAnswered} className={`w-full text-left p-4 rounded-xl border-2 transition-all flex items-center ${hasAnswered ? (opt===q.correctAnswer?'border-green-500 bg-green-50':(opt===userAnswer?'border-red-500 bg-red-50':'border-slate-100 opacity-50')) : `border-slate-200 hover:border-${ThemeColor}-300 hover:bg-${ThemeColor}-50`}`}>
                                    <span className="w-8 h-8 rounded-full border-2 mr-4 flex items-center justify-center font-bold">{String.fromCharCode(65+i)}</span>{opt}
                                 </button>
                             ))}
                          </div>
                          {hasAnswered && (
                              <div className="animate-slide-up bg-slate-50 -mx-6 -mb-6 p-6 rounded-b-2xl border-t border-slate-200">
                                  <div className={`font-bold text-lg mb-2 ${userAnswer===q.correctAnswer?'text-green-600':'text-red-500'}`}>{userAnswer===q.correctAnswer?'ç­”å°':'ç­”éŒ¯'}</div>
                                  <div className="text-slate-600 mb-4 text-sm">è§£æï¼š{q.explanation||"ç„¡"}</div>
                                  <button onClick={() => quizIndex < currentQuiz.length - 1 ? setQuizIndex(i=>i+1) : setActiveTab('quiz_summary')} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg">ä¸‹ä¸€é¡Œ</button>
                              </div>
                          )}
                       </div>
                     </div>
                   );
                })()}
                {activeTab === 'quiz_summary' && (
                  <div className="max-w-md mx-auto mt-10 p-10 bg-white rounded-2xl shadow-xl text-center animate-fade-in border border-slate-100">
                     <div className="text-6xl mb-6 animate-bounce-slow">ğŸ‰</div>
                     <div className={`text-5xl font-black text-${ThemeColor}-600 mb-2`}>{Math.round((calculateScore()/currentQuiz.length)*100)}åˆ†</div>
                     <div className="text-slate-500 mb-8">ç­”å° {calculateScore()} / {currentQuiz.length}</div>
                     <div className="flex gap-3">
                         <button onClick={()=>setActiveTab('quiz')} className="flex-1 bg-slate-100 py-3 rounded-xl font-bold">å›é¸å–®</button>
                         <button onClick={startQuiz} className={`flex-1 bg-${ThemeColor}-600 text-white py-3 rounded-xl font-bold`}>å†æ¸¬ä¸€æ¬¡</button>
                     </div>
                  </div>
                )}
              </div>
              
              {(() => {
                 const [o, sO] = useState(false);
                 return (
                     <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                         {o && (
                             <div className="mb-4 w-72 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden animate-slide-up">
                                 <div className={`bg-gradient-to-r from-${ThemeColor}-600 to-${ThemeColor}-700 text-white p-3 font-bold flex justify-between`}><span>ç³»çµ±å°å¹«æ‰‹</span><button onClick={()=>sO(false)}><X size={16}/></button></div>
                                 <div className="p-4 text-sm text-slate-600 space-y-3 h-80 overflow-y-auto">
                                     <div className="space-y-1">
                                        <p className="font-bold text-slate-800 flex items-center"><Plus size={16} className="mr-1"/> 1. æ–°å¢é¡Œç›®</p>
                                        <p className="text-xs ml-5">åœ¨ã€Œæ–°å¢ã€é é¢è¼¸å…¥ç§‘ç›®ã€é¡Œç›®ã€é¸é …èˆ‡ç­”æ¡ˆï¼Œå»ºç«‹è‡ªå·±çš„é¡Œåº«ã€‚</p>
                                     </div>
                                     <div className="space-y-1">
                                        <p className="font-bold text-slate-800 flex items-center"><FolderOpen size={16} className="mr-1"/> 2. åŒ¯å…¥/åŒ¯å‡º</p>
                                        <p className="text-xs ml-5">åœ¨ã€Œç®¡ç†ã€é é¢å¯é€é Excel æ‰¹é‡åŒ¯å…¥é¡Œç›®ï¼Œæˆ–å‚™ä»½ç›®å‰é¡Œåº«ã€‚</p>
                                     </div>
                                     <div className="space-y-1">
                                        <p className="font-bold text-slate-800 flex items-center"><Play size={16} className="mr-1"/> 3. é–‹å§‹æ¸¬é©—</p>
                                        <p className="text-xs ml-5">é»æ“Šã€Œæ¸¬é©—ã€é¸æ“‡ç¯„åœã€‚ã€ŒéŒ¯é¡Œè¤‡ç¿’ã€æ¨¡å¼å¯é‡å°ç­”éŒ¯çš„é¡Œç›®åŠ å¼·ç·´ç¿’ã€‚</p>
                                     </div>
                                     <div className="bg-blue-50 p-2 rounded border border-blue-100 mt-2">
                                         <strong className="text-blue-800 text-xs">ğŸ’¡ å°æç¤º</strong>
                                         <p className="text-xs text-blue-600">ç­”éŒ¯çš„é¡Œç›®æœƒè‡ªå‹•é€²å…¥éŒ¯é¡Œåº«ï¼Œç­”å°å¾Œè‡ªå‹•ç§»é™¤ã€‚</p>
                                     </div>
                                 </div>
                             </div>
                         )}
                         <button onClick={()=>sO(!o)} className={`${o?'bg-slate-500':`bg-${ThemeColor}-600`} text-white p-4 rounded-full shadow-lg transition-transform hover:scale-105 flex items-center justify-center`}>{o?<X size={24}/>:<MessageCircleQuestion size={28}/>}</button>
                     </div>
                 );
              })()}
            </div>
          );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamSystem />);
    </script>
</body>
</html>
