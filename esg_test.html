<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPASæ·¨é›¶ä¸­ç´šè€ƒè©¦ç·´ç¿’ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React/ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- è¼‰å…¥ Babel CDN (ç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­ç·¨è­¯ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* ç¢ºä¿å­—é«”å¯è®€æ€§ */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        /* ç°¡å–®çš„æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ (å–ä»£ lucide-react ä»¥é¿å…è¼‰å…¥éŒ¯èª¤) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            width={size} 
            height={size} 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            className={className}
          >
            {children}
          </svg>
        );

        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const FileJson = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M10 13a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2"/><path d="M14 13a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const FolderOpen = (props) => <IconBase {...props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const FileSpreadsheet = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h8"/><path d="M8 17h8"/><path d="M14 13v4"/></IconBase>;
        const Clipboard = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>;

        // é è¨­çš„ç¯„ä¾‹é¡Œç›® (å·²æ¸…ç©ºï¼Œä¾ä½¿ç”¨è€…è¦æ±‚)
        const DEFAULT_QUESTIONS = [];

        // --- é è¨­è€ƒç§‘çµæ§‹ (ä¿ç•™ï¼Œç”¨æ–¼é¸å–®é€£å‹•) ---
        const EXAM_STRUCTURE = {
          "è€ƒç§‘ä¸€ï¼šç¯€èƒ½æ¸›ç¢³æŠ€è¡“å¯¦å‹™": {
            "çµ„ç¹”ç¯€èƒ½æ¸›ç¢³ç­–ç•¥": [
              "æ¸›ç¢³/ç¯€èƒ½ç›®æ¨™è¨­å®šèˆ‡è·¯å¾‘è¦åŠƒ",
              "ç¢³æ’ç†±å€è¾¨è­˜èˆ‡èƒ½æºç›¤æŸ¥è³‡æ–™è§£æ",
              "è²¡å‹™æ±ºç­–æ¨¡å‹èˆ‡é¢¨éšªè©•ä¼°"
            ],
            "ç¯€èƒ½æŠ€è¡“æ‡‰ç”¨èˆ‡èƒ½æºç®¡ç†": [
              "å…¬ç”¨è¨­æ–½ç¯€èƒ½æŠ€è¡“é¸ç”¨åˆ†æ",
              "ç¯€èƒ½æŠ€è¡“æŠ•è³‡æ•ˆç›Šèˆ‡å›æ”¶æœŸè©•ä¼°",
              "ESCOæ‡‰ç”¨å¯¦å‹™",
              "ISO 50001èƒ½æºç®¡ç†ç³»çµ±å°å…¥èˆ‡é‹ç”¨",
              "ç¯€èƒ½ç›¸é—œå‰ç»æŠ€è¡“ï¼ˆå¦‚æ°«èƒ½ã€å„²èƒ½ç³»çµ±ã€æ™ºæ…§èƒ½æºç­‰ï¼‰"
            ],
            "å†ç”Ÿèƒ½æºèˆ‡ç¶ é›»å°å…¥": [
              "å†ç”Ÿèƒ½æºç¨®é¡åŠå„ªç¼ºé»æ¯”è¼ƒ",
              "åœ‹å…§å†ç”Ÿèƒ½æºå°å…¥åŠæ•ˆç›Šè©•ä¼°",
              "ç¶ é›»æ¡è³¼æ¨¡å¼èˆ‡åˆ¶åº¦ï¼ˆå¦‚T-RECã€CPPAã€è‡ªç™¼è‡ªç”¨ç­‰ï¼‰"
            ]
          },
          "è€ƒç§‘äºŒï¼šç¢³ç®¡ç†åˆ¶åº¦å¯¦å‹™": {
            "ç¢³è¦ç¯„å¯¦å‹™èˆ‡æ­éœ²æº–å‰‡æ‡‰ç”¨": [
              "åœ‹å…§æ°£å€™ç›¸é—œæ”¿ç­–èˆ‡æ¸›ç¢³æ³•è¦ä¹‹æ‡‰ç”¨ï¼ˆå¦‚æ°£å€™è®Šé·å› æ‡‰æ³•ã€ä¸‰å­æ³•ç­‰ï¼‰",
              "åœ‹éš›æ­éœ²åˆ¶åº¦æ¶æ§‹ç†è§£èˆ‡å¯¦å‹™æ‡‰ç”¨ï¼ˆå¦‚IFRSã€GRIã€SASBç­‰ï¼‰",
              "æ¸›ç¢³ç›¸é—œå€¡è­°èˆ‡æº–å‰‡å¯¦å‹™æ¥è»Œï¼ˆå¦‚SBTiã€TCFDã€TNFDç­‰ï¼‰"
            ],
            "çµ„ç¹”è‡ªé¡˜æ¸›é‡å¯¦å‹™": [
              "åœ‹å…§å¤–è‡ªé¡˜æ¸›é‡å°ˆæ¡ˆèˆ‡æŠµæ›åˆ¶åº¦",
              "ç¢³ç§»é™¤èˆ‡è² ç¢³æŠ€è¡“ï¼ˆå¦‚ç¢³åŒ¯ã€CCUSç­‰ï¼‰",
              "ç¢³æŠµæ›èˆ‡ç¢³è³‡æºäº¤æ˜“",
              "å…§éƒ¨ç¢³å®šåƒ¹èˆ‡ç¢³è³‡ç”¢ç®¡ç†"
            ],
            "æ°¸çºŒä¾›æ‡‰éˆç®¡ç†": [
              "ç¯„ç–‡ä¸‰ç¢³æ’æ•¸æ“šç›¤æŸ¥èˆ‡ä¼°ç®—å¯¦å‹™",
              "ä¾›æ‡‰éˆæ¸›ç¢³é¢¨éšªè©•ä¼°èˆ‡ç®¡ç†æ©Ÿåˆ¶"
            ]
          }
        };

        function ExamSystem() {
          // --- State ---
          const [questions, setQuestions] = useState(() => {
            try {
              const saved = localStorage.getItem('myExamBank');
              // å¦‚æœæœ¬åœ°æœ‰å­˜æª”ï¼Œå‰‡ä½¿ç”¨å­˜æª”ï¼›å¦‚æœæ²’æœ‰ï¼Œå‰‡ä½¿ç”¨ç©ºé™£åˆ—
              return saved ? JSON.parse(saved) : DEFAULT_QUESTIONS; 
            } catch (e) {
              console.error("Storage read error, starting with default questions.", e);
              return DEFAULT_QUESTIONS;
            }
          });

          const [activeTab, setActiveTab] = useState('add');
          const [notification, setNotification] = useState(null);

          // æ–°å¢é¡Œç›® State
          const [newQ, setNewQ] = useState({
            subject: '',
            section: '',
            topic: '',
            question: '',
            options: ['', '', '', ''],
            correctAnswer: '',
            explanation: ''
          });

          // æ‰¹é‡åŒ¯å…¥ State
          const [bulkText, setBulkText] = useState('');
          const [bulkPreview, setBulkPreview] = useState([]);
          const fileInputRef = useRef(null);

          // æ¸¬é©— State
          const [quizConfig, setQuizConfig] = useState({ subject: 'all', mode: 'all' });
          const [currentQuiz, setCurrentQuiz] = useState([]);
          const [quizIndex, setQuizIndex] = useState(0);
          const [showResult, setShowResult] = useState(false);
          const [userSelection, setUserSelection] = useState(null);
          const [score, setScore] = useState(0);

          // --- Effects ---
          useEffect(() => {
            try {
              localStorage.setItem('myExamBank', JSON.stringify(questions));
            } catch (e) {
              console.error("Storage error", e);
            }
          }, [questions]);

          // --- Helpers ---
          const showNotify = (msg) => {
            setNotification(msg);
            setTimeout(() => setNotification(null), 3000);
          };

          const getAvailableSubjects = () => {
            const presetSubjects = Object.keys(EXAM_STRUCTURE);
            const existingSubjects = questions.map(q => q.subject).filter(Boolean);
            return [...new Set([...presetSubjects, ...existingSubjects])];
          };

          const getAvailableSections = (currentSubject) => {
            let sections = [];
            if (EXAM_STRUCTURE[currentSubject]) {
              sections = [...Object.keys(EXAM_STRUCTURE[currentSubject])];
            }
            const existingSections = questions
              .filter(q => q.subject === currentSubject)
              .map(q => q.section)
              .filter(Boolean);
              
            return [...new Set([...sections, ...existingSections])];
          };

          const getAvailableTopics = (currentSubject, currentSection) => {
            let topics = [];
            if (EXAM_STRUCTURE[currentSubject] && EXAM_STRUCTURE[currentSubject][currentSection]) {
              topics = [...EXAM_STRUCTURE[currentSubject][currentSection]];
            }
            const existingTopics = questions
              .filter(q => q.subject === currentSubject && q.section === currentSection)
              .map(q => q.topic)
              .filter(Boolean);

            return [...new Set([...topics, ...existingTopics])];
          };

          // --- Handlers: Add Question ---
          const handleAddOption = () => {
            setNewQ({ ...newQ, options: [...newQ.options, ''] });
          };

          const handleOptionChange = (index, value) => {
            const newOptions = [...newQ.options];
            newOptions[index] = value;
            setNewQ({ ...newQ, options: newOptions });
          };

          const handleRemoveOption = (index) => {
            const newOptions = newQ.options.filter((_, i) => i !== index);
            setNewQ({ ...newQ, options: newOptions });
          };

          const saveQuestion = () => {
            if (!newQ.subject || !newQ.question || !newQ.correctAnswer) {
              showNotify("è«‹è‡³å°‘å¡«å¯«ï¼šç§‘ç›®ã€é¡Œç›®ã€æ­£ç¢ºç­”æ¡ˆ");
              return;
            }

            const questionToAdd = {
              ...newQ,
              id: Date.now(),
              type: 'single'
            };

            setQuestions([...questions, questionToAdd]);
            showNotify("é¡Œç›®å·²æ–°å¢ï¼");
            setNewQ({ 
              ...newQ, 
              question: '', 
              options: ['', '', '', ''], 
              correctAnswer: '', 
              explanation: '' 
            });
          };

          const deleteQuestion = (id) => {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é¡Œå—ï¼Ÿ")) {
              setQuestions(questions.filter(q => q.id !== id));
              showNotify("é¡Œç›®å·²åˆªé™¤");
            }
          };

          // --- Handlers: Bulk Import (CSV/Excel Copy Paste) ---
          
          // CSV Line Parser: handles quotes properly (e.g. "A, B, C")
          const parseCSVRow = (rowStr, delimiter = ',') => {
            const chars = rowStr.split('');
            const cols = [];
            let current = '';
            let inQuote = false;

            for (let i = 0; i < chars.length; i++) {
              const c = chars[i];
              if (c === '"') {
                // Toggle quote state
                if (inQuote && chars[i+1] === '"') {
                   // Double quote escape
                   current += '"';
                   i++; 
                } else {
                   inQuote = !inQuote;
                }
              } else if (c === delimiter && !inQuote) {
                cols.push(current.trim());
                current = '';
              } else {
                current += c;
              }
            }
            cols.push(current.trim());
            return cols;
          };

          const processImportContent = (content) => {
            if (!content.trim()) return;

            // Detect delimiter: if many tabs are found, assume TSV (Excel copy paste or .txt)
            // otherwise assume CSV (comma)
            const firstLine = content.split('\n')[0];
            const delimiter = firstLine.includes('\t') ? '\t' : ',';

            const rows = content.split('\n').filter(row => row.trim() !== '');
            const parsed = [];

            rows.forEach((row, index) => {
              // Use the parser to handle quotes safely if CSV
              const cols = parseCSVRow(row, delimiter);
              
              // Expected structure:
              // 0:Subject | 1:Section | 2:Topic | 3:Question | 4:OptA | 5:OptB | 6:OptC | 7:OptD | 8:CorrectAns | 9:Explanation
              
              if (cols.length < 9) {
                return; 
              }

              // Try to determine the correct answer
              let correct = cols[8];
              // Strip quotes if present
              if (correct && correct.startsWith('"') && correct.endsWith('"')) correct = correct.slice(1, -1);
              
              const opts = [cols[4], cols[5], cols[6], cols[7]];
              if (correct && correct.toUpperCase() === 'A') correct = cols[4];
              if (correct && correct.toUpperCase() === 'B') correct = cols[5];
              if (correct && correct.toUpperCase() === 'C') correct = cols[6];
              if (correct && correct.toUpperCase() === 'D') correct = cols[7];

              parsed.push({
                id: Date.now() + index + Math.random(), // ensure unique
                subject: cols[0] || 'æœªåˆ†é¡ç§‘ç›®',
                section: cols[1] || '',
                topic: cols[2] || '',
                question: cols[3],
                options: opts.filter(o => o),
                correctAnswer: correct,
                explanation: cols[9] || '',
                type: 'single'
              });
            });

            setBulkPreview(parsed);
            if (parsed.length > 0) {
               showNotify(`æˆåŠŸè§£æ ${parsed.length} ç­†è³‡æ–™ï¼è«‹æª¢è¦–å¾ŒæŒ‰ç¢ºèªã€‚`);
            } else {
               showNotify(`è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ (åˆ†éš”ç¬¦è™Ÿ: ${delimiter === '\t' ? 'Tab' : 'é€—è™Ÿ'})`);
            }
          };

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              const text = e.target.result;
              setBulkText(text); // Also show in textarea
              processImportContent(text);
            };
            reader.readAsText(file); // Default UTF-8
            // Reset input
            event.target.value = '';
          };

          const confirmBulkImport = () => {
            if (bulkPreview.length === 0) {
                showNotify("è«‹å…ˆè§£æå…§å®¹ï¼Œæ‰èƒ½é€²è¡ŒåŒ¯å…¥ã€‚");
                return;
            }
            
            // é€²è¡Œç‹€æ…‹æ›´æ–°å’Œç¢ºèª
            if (confirm(`ç¢ºèªåŒ¯å…¥ ${bulkPreview.length} é¡Œï¼ŸåŒ¯å…¥å¾Œé¡Œåº«ç¸½æ•¸å°‡è®Šç‚º ${questions.length + bulkPreview.length} é¡Œã€‚`)) {
              
              const newQuestions = [...questions, ...bulkPreview];
              setQuestions(newQuestions);
              
              // å„ªåŒ–ï¼šæä¾›æ›´æ˜ç¢ºçš„æˆåŠŸè¨Šæ¯å’Œç¸½æ•¸
              showNotify(`âœ“ æˆåŠŸåŒ¯å…¥ ${bulkPreview.length} é¡Œï¼ç›®å‰é¡Œåº«ç¸½æ•¸ï¼š${newQuestions.length} é¡Œ`);
              
              // æ¸…ç†æ‰¹é‡åŒ¯å…¥çš„æš«å­˜ç‹€æ…‹
              setBulkText('');
              setBulkPreview([]);
              
              // ç”±æ–¼ç‹€æ…‹æ˜¯ç•°æ­¥æ›´æ–°ï¼Œé€™è£¡çš„ console.log åªæ˜¯è¼”åŠ©æª¢æŸ¥
              console.log(`Import confirmed. New total questions: ${newQuestions.length}`);
            }
          };

          // --- Handlers: Quiz ---
          const startQuiz = () => {
            let qList = questions;
            if (quizConfig.subject !== 'all') {
              qList = questions.filter(q => q.subject === quizConfig.subject);
            }
            
            qList = qList.sort(() => Math.random() - 0.5);

            if (qList.length === 0) {
              showNotify("è©²ç¯„åœæ²’æœ‰é¡Œç›®ï¼");
              return;
            }

            setCurrentQuiz(qList);
            setQuizIndex(0);
            setScore(0);
            setShowResult(false);
            setUserSelection(null);
            setActiveTab('quiz_running');
          };

          const handleAnswerSubmit = (option) => {
            setUserSelection(option);
            setShowResult(true);
            if (option === currentQuiz[quizIndex].correctAnswer) {
              setScore(score + 1);
            }
          };

          const nextQuestion = () => {
            if (quizIndex < currentQuiz.length - 1) {
              setQuizIndex(quizIndex + 1);
              setShowResult(false);
              setUserSelection(null);
            } else {
              setActiveTab('quiz_summary');
            }
          };

          // --- Handlers: JSON Import/Export ---
          const exportData = () => {
            const dataStr = JSON.stringify(questions, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `iPAS_Exam_Bank_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                  if (confirm(`å³å°‡åŒ¯å…¥ ${imported.length} é¡Œï¼Œé€™æœƒèˆ‡ç¾æœ‰é¡Œç›®åˆä½µï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                     setQuestions([...questions, ...imported]);
                     showNotify("åŒ¯å…¥æˆåŠŸï¼");
                  }
                } else {
                  showNotify("æ ¼å¼éŒ¯èª¤ï¼šæª”æ¡ˆå¿…é ˆæ˜¯ JSON é™£åˆ—");
                }
              } catch (err) {
                showNotify("æª”æ¡ˆè®€å–å¤±æ•—");
              }
            };
            reader.readAsText(file);
          };

          // --- Components ---

          const Navigation = () => (
            <div className="flex bg-slate-800 text-white p-2 overflow-x-auto space-x-2 shadow-md">
              <button 
                onClick={() => setActiveTab('add')} 
                className={`flex items-center px-4 py-2 rounded-md transition whitespace-nowrap ${activeTab === 'add' ? 'bg-blue-600' : 'hover:bg-slate-700'}`}
              >
                <Plus size={18} className="mr-2" /> æ–°å¢
              </button>
              <button 
                onClick={() => setActiveTab('bank')} 
                className={`flex items-center px-4 py-2 rounded-md transition whitespace-nowrap ${activeTab === 'bank' ? 'bg-blue-600' : 'hover:bg-slate-700'}`}
              >
                <BookOpen size={18} className="mr-2" /> é¡Œåº« ({questions.length})
              </button>
              <button 
                onClick={() => setActiveTab('quiz')} 
                className={`flex items-center px-4 py-2 rounded-md transition whitespace-nowrap ${activeTab === 'quiz' ? 'bg-blue-600' : 'hover:bg-slate-700'}`}
              >
                <Play size={18} className="mr-2" /> æ¸¬é©—
              </button>
              <button 
                onClick={() => setActiveTab('import')} 
                className={`flex items-center px-4 py-2 rounded-md transition whitespace-nowrap ${activeTab === 'import' ? 'bg-blue-600' : 'hover:bg-slate-700'}`}
              >
                <FolderOpen size={18} className="mr-2" /> ç®¡ç†
              </button>
            </div>
          );

          const AddTab = () => {
            const availableSubjects = getAvailableSubjects();
            const availableSections = getAvailableSections(newQ.subject);
            const availableTopics = getAvailableTopics(newQ.subject, newQ.section);

            return (
              <div className="max-w-3xl mx-auto p-4 bg-white rounded-lg shadow mt-4">
                <h2 className="text-xl font-bold mb-4 text-slate-800 border-b pb-2 flex items-center">
                  <Plus size={20} className="mr-2"/> æ–°å¢é¡Œç›® (ä¸‰å±¤æ¶æ§‹)
                </h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center">
                       <Layers size={14} className="mr-1"/> å±¤ç´š 1ï¼šç§‘ç›®åç¨±
                    </label>
                    <input 
                      list="subjects" 
                      type="text" 
                      className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50"
                      placeholder="é¸æ“‡æˆ–è¼¸å…¥è€ƒç§‘..."
                      value={newQ.subject}
                      onChange={(e) => setNewQ({...newQ, subject: e.target.value, section: '', topic: ''})}
                    />
                    <datalist id="subjects">
                      {availableSubjects.map(s => <option key={s} value={s} />)}
                    </datalist>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">å±¤ç´š 2ï¼šè©•é‘‘ä¸»é¡Œ</label>
                    <input 
                      list="sections"
                      type="text" 
                      className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50"
                      placeholder="é¸æ“‡æˆ–è¼¸å…¥ä¸»é¡Œ..."
                      value={newQ.section}
                      onChange={(e) => setNewQ({...newQ, section: e.target.value, topic: ''})}
                      disabled={!newQ.subject}
                    />
                    <datalist id="sections">
                      {availableSections.map(s => <option key={s} value={s} />)}
                    </datalist>
                  </div>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-slate-700 mb-1">å±¤ç´š 3ï¼šè©•é‘‘å…§å®¹</label>
                  <input 
                    list="topics"
                    type="text" 
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50"
                    placeholder="é¸æ“‡æˆ–è¼¸å…¥å…§å®¹..."
                    value={newQ.topic}
                    onChange={(e) => setNewQ({...newQ, topic: e.target.value})}
                    disabled={!newQ.section}
                  />
                  <datalist id="topics">
                      {availableTopics.map(t => <option key={t} value={t} />)}
                  </datalist>
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-slate-700 mb-1">é¡Œç›®å…§å®¹</label>
                  <textarea 
                    className="w-full p-2 border rounded h-24 focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="è«‹è¼¸å…¥é¡Œç›®æ•˜è¿°..."
                    value={newQ.question}
                    onChange={(e) => setNewQ({...newQ, question: e.target.value})}
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-slate-700 mb-1">é¸é … (é»é¸åœ“åœˆè¨­å®šæ­£ç¢ºç­”æ¡ˆ)</label>
                  {newQ.options.map((opt, idx) => (
                    <div key={idx} className="flex items-center mb-2 gap-2">
                      <input 
                        type="radio" 
                        name="correctAnswer" 
                        checked={newQ.correctAnswer === opt && opt !== ''}
                        onChange={() => setNewQ({...newQ, correctAnswer: opt})}
                        className="w-4 h-4 text-blue-600 cursor-pointer"
                      />
                      <span className="text-gray-500 w-6 text-center">{String.fromCharCode(65+idx)}</span>
                      <input 
                        type="text" 
                        className="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder={`é¸é … ${idx + 1}`}
                        value={opt}
                        onChange={(e) => handleOptionChange(idx, e.target.value)}
                      />
                      <button onClick={() => handleRemoveOption(idx)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                    </div>
                  ))}
                  <button onClick={handleAddOption} className="text-sm text-blue-600 hover:text-blue-800 flex items-center mt-1">
                    <Plus size={14} className="mr-1"/> å¢åŠ é¸é …
                  </button>
                </div>

                <div className="mb-6">
                  <label className="block text-sm font-medium text-slate-700 mb-1">è§£æ (é¸å¡«)</label>
                  <textarea 
                    className="w-full p-2 border rounded h-20 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50"
                    placeholder="è¼¸å…¥è§£ææˆ–æ³•è¦ä¾†æº..."
                    value={newQ.explanation}
                    onChange={(e) => setNewQ({...newQ, explanation: e.target.value})}
                  />
                </div>

                <button 
                  onClick={saveQuestion}
                  className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex justify-center items-center shadow-md"
                >
                  <Save size={20} className="mr-2" /> å„²å­˜é¡Œç›®
                </button>
              </div>
            );
          };

          const BankTab = () => {
            const [filterSubject, setFilterSubject] = useState('all');
            const allSubjects = getAvailableSubjects();
            
            const filteredQuestions = filterSubject === 'all' 
              ? questions 
              : questions.filter(q => q.subject === filterSubject);

            return (
              <div className="max-w-4xl mx-auto p-4">
                <div className="flex justify-between items-center mb-4 bg-white p-3 rounded shadow-sm">
                  <h2 className="text-xl font-bold text-slate-800 flex items-center">
                    <BookOpen size={20} className="mr-2"/> é¡Œåº«ç¸½è¦½
                  </h2>
                  <select 
                    className="p-2 border rounded bg-slate-50 max-w-[200px] text-sm"
                    value={filterSubject}
                    onChange={(e) => setFilterSubject(e.target.value)}
                  >
                    <option value="all">é¡¯ç¤ºæ‰€æœ‰ç§‘ç›®</option>
                    {allSubjects.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>

                <div className="space-y-4">
                  {filteredQuestions.length === 0 ? (
                    <div className="text-center text-gray-500 py-10 border-2 border-dashed border-gray-300 rounded-lg">
                      ç›®å‰æ²’æœ‰é¡Œç›®ï¼Œè«‹å‰å¾€ã€Œæ–°å¢ã€é é¢è¼¸å…¥è€ƒé¡Œï¼Œæˆ–ä½¿ç”¨ã€Œç®¡ç†ã€é é¢çš„åŒ¯å…¥åŠŸèƒ½ã€‚
                    </div>
                  ) : filteredQuestions.map((q, idx) => (
                    <div key={q.id} className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 relative group">
                      <button 
                        onClick={() => deleteQuestion(q.id)}
                        className="absolute top-4 right-4 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"
                      >
                        <Trash2 size={18} />
                      </button>
                      <div className="flex flex-wrap gap-2 mb-2 text-xs">
                         <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">{q.subject}</span>
                         {q.section && <span className="bg-green-100 text-green-800 px-2 py-1 rounded">{q.section}</span>}
                         {q.topic && <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded">{q.topic}</span>}
                      </div>
                      
                      <h3 className="font-semibold text-slate-800 mb-2 mt-1">{idx + 1}. {q.question}</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-600 mb-3">
                        {q.options.map((opt, i) => (
                          <div key={i} className={`p-2 rounded ${opt === q.correctAnswer ? 'bg-green-100 text-green-800 font-bold border border-green-200' : 'bg-gray-50'}`}>
                            {String.fromCharCode(65+i)}. {opt}
                          </div>
                        ))}
                      </div>
                      {q.explanation && (
                        <div className="text-sm text-slate-500 bg-slate-50 p-2 rounded border border-slate-100">
                          <span className="font-bold text-slate-700">è§£æï¼š</span>{q.explanation}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          const QuizSetupTab = () => {
             const allSubjects = getAvailableSubjects();
             return (
                <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow text-center">
                  <Play size={48} className="mx-auto text-blue-500 mb-4" />
                  <h2 className="text-2xl font-bold mb-6">æ¸¬é©—è¨­å®š</h2>
                  
                  <div className="mb-6 text-left">
                    <label className="block text-sm font-medium text-slate-700 mb-2">è«‹é¸æ“‡æ¸¬é©—ç§‘ç›® (Level 1)</label>
                    <select 
                      className="w-full p-3 border rounded bg-slate-50"
                      value={quizConfig.subject}
                      onChange={(e) => setQuizConfig({...quizConfig, subject: e.target.value})}
                    >
                      <option value="all">å…¨éƒ¨è€ƒç§‘ ({questions.length} é¡Œ)</option>
                      {allSubjects.map(s => (
                        <option key={s} value={s}>{s} ({questions.filter(q => q.subject === s).length} é¡Œ)</option>
                      ))}
                    </select>
                  </div>

                  <button 
                    onClick={startQuiz}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition"
                  >
                    é–‹å§‹æ¸¬é©—
                  </button>
                </div>
             );
          };

          const QuizRunning = () => {
            const q = currentQuiz[quizIndex];
            if (!q) return null;

            return (
              <div className="max-w-2xl mx-auto mt-6 p-6 bg-white rounded-lg shadow-lg">
                <div className="mb-4 text-xs text-slate-500 flex flex-wrap gap-2 items-center border-b pb-2">
                  <span className="font-bold text-blue-600">{q.subject}</span>
                  {q.section && <span>/ {q.section}</span>}
                  {q.topic && <span>/ {q.topic}</span>}
                  <span className="ml-auto bg-gray-100 px-2 py-1 rounded text-gray-600">é¡Œæ•¸ {quizIndex + 1} / {currentQuiz.length}</span>
                </div>
                
                <div className="mb-6">
                  <h2 className="text-xl font-bold text-slate-800 leading-relaxed">{q.question}</h2>
                </div>

                <div className="space-y-3 mb-6">
                  {q.options.map((opt, idx) => {
                    let itemClass = "w-full text-left p-4 rounded border transition flex items-center ";
                    if (showResult) {
                      if (opt === q.correctAnswer) itemClass += "bg-green-100 border-green-500 text-green-900 font-bold";
                      else if (opt === userSelection && opt !== q.correctAnswer) itemClass += "bg-red-100 border-red-500 text-red-900";
                      else itemClass += "bg-gray-50 opacity-60";
                    } else {
                      itemClass += "hover:bg-blue-50 hover:border-blue-300 bg-white border-gray-200";
                    }

                    return (
                      <button 
                        key={idx} 
                        onClick={() => !showResult && handleAnswerSubmit(opt)}
                        disabled={showResult}
                        className={itemClass}
                      >
                        <span className="w-6 h-6 rounded-full border border-current mr-3 flex items-center justify-center text-xs">
                          {String.fromCharCode(65+idx)}
                        </span>
                        {opt}
                      </button>
                    )
                  })}
                </div>

                {showResult && (
                  <div className="animate-fade-in mb-6 p-4 bg-slate-50 rounded border border-slate-200">
                    <div className={`flex items-center font-bold mb-2 ${userSelection === q.correctAnswer ? 'text-green-600' : 'text-red-600'}`}>
                      {userSelection === q.correctAnswer ? <CheckCircle className="mr-2"/> : <XCircle className="mr-2"/>}
                      {userSelection === q.correctAnswer ? "ç­”å°äº†ï¼" : "ç­”éŒ¯äº†ï¼"}
                    </div>
                    <p className="text-slate-700"><span className="font-bold">æ­£ç¢ºç­”æ¡ˆï¼š</span> {q.correctAnswer}</p>
                    {q.explanation && (
                      <p className="text-slate-600 mt-2 text-sm"><span className="font-bold">è§£æï¼š</span> {q.explanation}</p>
                    )}
                  </div>
                )}

                {showResult && (
                  <button 
                    onClick={nextQuestion}
                    className="w-full bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-900 transition font-bold"
                  >
                    {quizIndex < currentQuiz.length - 1 ? "ä¸‹ä¸€é¡Œ" : "æŸ¥çœ‹çµæœ"}
                  </button>
                )}
              </div>
            );
          };

          const QuizSummary = () => (
            <div className="max-w-md mx-auto mt-10 p-8 bg-white rounded-lg shadow text-center">
              <div className="text-6xl mb-4">ğŸ‰</div>
              <h2 className="text-2xl font-bold mb-2">æ¸¬é©—å®Œæˆï¼</h2>
              <p className="text-slate-500 mb-6">æ‚¨åœ¨ {currentQuiz.length} é¡Œä¸­ç­”å°äº† {score} é¡Œã€‚</p>
              
              <div className="text-4xl font-bold text-blue-600 mb-8">
                {Math.round((score / currentQuiz.length) * 100)}åˆ†
              </div>

              <div className="flex gap-4">
                <button 
                  onClick={() => setActiveTab('quiz')}
                  className="flex-1 bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300"
                >
                  è¿”å›é¸å–®
                </button>
                <button 
                  onClick={startQuiz}
                  className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                >
                  å†æ¸¬ä¸€æ¬¡
                </button>
              </div>
            </div>
          );

          const ImportExportTab = () => (
            <div className="max-w-4xl mx-auto p-4 space-y-8">
              
              {/* 1. Excel / CSV å¿«é€ŸåŒ¯å…¥ */}
              <section className="bg-white p-6 rounded-lg shadow border border-blue-200">
                <h3 className="font-bold text-xl mb-4 flex items-center text-blue-800">
                  <FileSpreadsheet className="mr-2"/> Excel / CSV å¿«é€ŸåŒ¯å…¥
                </h3>
                <div className="bg-blue-50 p-4 rounded mb-4 text-sm text-blue-800">
                  <p className="font-bold mb-2">ä½¿ç”¨èªªæ˜ï¼š</p>
                  <ol className="list-decimal list-inside space-y-1">
                    <li>åœ¨ Excel ä¸­æ•´ç†è€ƒé¡Œï¼Œè«‹ä¾ç…§ä»¥ä¸‹ 10 å€‹æ¬„ä½é †åºæ’åˆ—ï¼š</li>
                    <li className="font-mono bg-white px-2 py-1 rounded border border-blue-200 inline-block text-xs mt-1 mb-1">
                      ç§‘ç›® | ä¸»é¡Œ | å…§å®¹ | é¡Œç›® | é¸é …A | é¸é …B | é¸é …C | é¸é …D | æ­£ç¢ºç­”æ¡ˆ | è§£æ
                    </li>
                    <li>å°‡ Excel å¦å­˜ç‚º <strong>CSV (é€—è™Ÿåˆ†éš”)</strong> æ ¼å¼ï¼Œæˆ–å°‡ Excel å…§å®¹è¤‡è£½è²¼ä¸Šåˆ°ä¸‹æ–¹ã€‚</li>
                  </ol>
                </div>

                <div className="mb-4 flex gap-4 items-end">
                   <div className="flex-1">
                     <label className="block text-sm font-bold text-slate-700 mb-2">æ–¹å¼ä¸€ï¼šç›´æ¥ä¸Šå‚³ CSV æª”æ¡ˆ</label>
                     <input 
                       type="file" 
                       accept=".csv,.txt"
                       ref={fileInputRef}
                       onChange={handleFileUpload}
                       className="block w-full text-sm text-slate-500
                         file:mr-4 file:py-2 file:px-4
                         file:rounded-full file:border-0
                         file:text-sm file:font-semibold
                         file:bg-blue-50 file:text-blue-700
                         hover:file:bg-blue-100
                       "
                     />
                   </div>
                </div>
                
                <label className="block text-sm font-bold text-slate-700 mb-2">æ–¹å¼äºŒï¼šè¤‡è£½è²¼ä¸Šæ–‡å­— (CSV æˆ– Tab åˆ†éš”)</label>
                <textarea 
                  className="w-full h-40 p-3 border rounded focus:ring-2 focus:ring-blue-500 text-sm font-mono whitespace-pre mb-4"
                  placeholder="è«‹åœ¨æ­¤è™•è²¼ä¸Š CSV å…§å®¹æˆ– Excel è¤‡è£½çš„æ–‡å­—..."
                  value={bulkText}
                  onChange={(e) => {
                    setBulkText(e.target.value);
                    // ç•¶ç”¨æˆ¶è²¼ä¸Šæ™‚ï¼Œä¸ç”¨ç«‹å³è§£æï¼Œç­‰æŒ‰ä¸‹æŒ‰éˆ•ï¼Œæˆ–è€…å¯ä»¥åŠ å€‹debounce
                  }}
                />

                <div className="flex gap-2">
                   <button 
                     onClick={() => processImportContent(bulkText)}
                     className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition flex items-center"
                   >
                     <Clipboard className="mr-2" size={18}/> è§£æå…§å®¹
                   </button>
                   {bulkPreview.length > 0 && (
                     <button 
                       onClick={confirmBulkImport}
                       className="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 transition flex items-center"
                     >
                       <CheckCircle className="mr-2" size={18}/> ç¢ºèªåŒ¯å…¥ {bulkPreview.length} é¡Œ
                     </button>
                   )}
                </div>

                {/* é è¦½å€åŸŸ */}
                {bulkPreview.length > 0 && (
                  <div className="mt-6 border-t pt-4">
                    <h4 className="font-bold text-gray-700 mb-2">åŒ¯å…¥é è¦½ (å‰ 3 ç­†)ï¼š</h4>
                    <div className="space-y-2">
                      {bulkPreview.slice(0, 3).map((q, i) => (
                        <div key={i} className="bg-gray-50 p-3 rounded border text-sm">
                          <div className="font-bold text-blue-600 mb-1">{q.subject} / {q.section}</div>
                          <div>Q: {q.question}</div>
                          <div className="text-gray-500 mt-1">Ans: {q.correctAnswer} | èªªæ˜: {q.explanation.slice(0, 30)}...</div>
                        </div>
                      ))}
                      {bulkPreview.length > 3 && <div className="text-center text-gray-500 text-sm">...é‚„æœ‰ {bulkPreview.length - 3} ç­†è³‡æ–™</div>}
                    </div>
                  </div>
                )}
              </section>

              {/* 2. JSON æª”æ¡ˆç®¡ç† */}
              <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-lg shadow border border-slate-200">
                  <h3 className="font-bold text-lg mb-4 flex items-center text-slate-700">
                    <Download className="mr-2"/> åŒ¯å‡ºå‚™ä»½ (JSON)
                  </h3>
                  <p className="text-sm text-slate-500 mb-4">å°‡å®Œæ•´çš„é¡Œåº«å‚™ä»½ä¸‹è¼‰ç‚ºæª”æ¡ˆï¼Œä»¥é˜²è³‡æ–™éºå¤±ã€‚</p>
                  <button onClick={exportData} className="w-full bg-slate-100 text-slate-700 py-2 rounded font-bold hover:bg-slate-200 transition border border-slate-300">
                    ä¸‹è¼‰é¡Œåº«æª”æ¡ˆ
                  </button>
                </div>

                <div className="bg-white p-6 rounded-lg shadow border border-slate-200">
                  <h3 className="font-bold text-lg mb-4 flex items-center text-slate-700">
                    <Upload className="mr-2"/> åŒ¯å…¥å‚™ä»½ (JSON)
                  </h3>
                  <p className="text-sm text-slate-500 mb-4">é¸æ“‡ä¹‹å‰åŒ¯å‡ºçš„ .json å‚™ä»½æª”ã€‚</p>
                  <label className="block w-full cursor-pointer bg-slate-100 text-slate-700 py-2 rounded font-bold hover:bg-slate-200 transition text-center border border-slate-300">
                    é¸æ“‡æª”æ¡ˆ
                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                  </label>
                </div>
              </section>

              <div className="bg-yellow-50 p-4 rounded border border-yellow-200 text-sm text-yellow-800 flex items-start">
                <div className="font-bold mr-2 text-lg">!</div>
                <div>
                   <strong>è³‡æ–™ä¿å­˜æç¤ºï¼š</strong> æ­¤ç³»çµ±ç›®å‰æ˜¯é›¢ç·šç‰ˆï¼Œè³‡æ–™åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚è«‹å‹™å¿…å®šæœŸä½¿ç”¨ã€ŒåŒ¯å‡ºå‚™ä»½ã€åŠŸèƒ½ä¸‹è¼‰ JSON æª”ï¼Œä»¥å…æ¸…é™¤ç€è¦½å™¨å¿«å–å¾Œè³‡æ–™éºå¤±ã€‚
                </div>
              </div>
            </div>
          );

          return (
            <div className="min-h-screen bg-slate-100 font-sans pb-10">
              <div className="bg-white shadow-sm sticky top-0 z-10">
                <div className="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                  <div className="flex items-center text-slate-800 font-bold text-xl">
                     <FileJson className="mr-2 text-blue-600"/> 
                     iPASæ·¨é›¶ä¸­ç´šè€ƒè©¦ç·´ç¿’ç³»çµ±
                  </div>
                  {notification && (
                    <div className="fixed top-20 right-4 bg-slate-800 text-white px-4 py-2 rounded shadow-lg animate-bounce z-50">
                      {notification}
                    </div>
                  )}
                </div>
                <Navigation />
              </div>

              <div className="max-w-5xl mx-auto mt-6 px-4">
                {activeTab === 'add' && <AddTab />}
                {activeTab === 'bank' && <BankTab />}
                {activeTab === 'quiz' && <QuizSetupTab />}
                {activeTab === 'quiz_running' && <QuizRunning />}
                {activeTab === 'quiz_summary' && <QuizSummary />}
                {activeTab === 'import' && <ImportExportTab />}
              </div>
            </div>
          );
        }
        
        // æ¸²æŸ“ React App
        ReactDOM.render(<ExamSystem />, document.getElementById('root'));

    </script>
</body>
</html>
